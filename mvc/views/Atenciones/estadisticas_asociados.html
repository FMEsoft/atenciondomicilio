{% extends 'Base/base.html' %} {% block wrapper %}

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
</head>
{% endblock %} {% block content %}
<div class="box">
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
			<h3 class="text-primary text-center">Estadisticas</h3>
			<div class="box box-primary">
				<div class="box-header with-border">
					<h3 class="box-title">Asociados que solicitan más atenciones (Titulares)</h3>
					<br>
					<br>

					<div class="row">
						<div class="col-md-6">
							<button class="btn btn-default" type="button" onclick="getData()">Estadistica por año</button>
							<br>
							<br>
							<select class="form-control" id="select-datos" onchange="asociados(this.value)" style='display:none;'></select>
						</div>

						<!-- FALTAN LOS SELECT PARA EL MES Y EL DIA -->

						<div class="col-md-6">
							<button class="btn btn-default" type="button" onclick="asociados(2016, 00, 00)">POR AÑO</button>
							<button class="btn btn-default" type="button" onclick="asociados(2016, 03, 00)">POR MES</button>
							<button class="btn btn-default" type="button" onclick="asociados(2016, 03, 11)">POR DIA</button>
						</div>
					</div>

					<div class="box-tools pull-right">
						<button class="btn btn-default" type="button" class="btn btn-box-tool" data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>
						<button class="btn btn-default" type="button" class="btn btn-box-tool" data-widget="remove">
							<i class="fa fa-times"></i>
						</button>
					</div>
				</div>

				<div class="box-body chart-responsive">
					<div class="chart" id="asociados-estadisticas" style="height:300px; width: 500px"></div>
				</div>

			</div>
			
			<!-- AQUI EMPIEZAN LOS DATOS A MOSTRAR EN LA ESTADISTICA -->
			<label>DATOS</label>
			</br>
			<label>Total de atenciones: </label>
			<p id="tot-atenciones"></p>
			<label>Total de asociados: </label>
			<p id="tot-asociados"></p>

		</div>
	</div>
</div>
{% endblock %} {% block javascript %}
<script> 
	//Función que rellena los datos del select, trae todos los años encontrados en la base de datos
	function getData() {
		$("#select-datos").empty();
		//Método POST de ajax para mandar:
		//1.- El PHP donde se va a procesar todo que es proceso_cantatenciones.php
		//2.- El o los datos, en este caso no requerimos datos
		//3.- Luego se llama a una función una vez que se enviaron los datos y se obtuvo una respuesta
		$.post("../controllers/estadisticas.php?funcion=cantidadAtencionesProceso", 0).done(function (data) {
			var data = $.parseJSON(data);
			//console.log(data);

			$.each(data, function (key, registro) {
				$("#select-datos").append('<option value=' + registro.anio + '>' + registro.anio + '</option>');
			});
		});

		document.getElementById('select-datos').style.display = 'block';
	}

	function asociados(anio, mes, dia) {
		var datos = {};

		if (mes == 00 && dia == 00)
			datos = { 'anio': anio };
		else
			if (dia == 00)
				datos = { 'anio': anio, 'mes': mes };
			else
				datos = { 'anio': anio, 'mes': mes, 'dia': dia };

		//Método POST de ajax para mandar:
		//1.- El PHP donde se va a procesar todo es el archivo estadisticas.php, se procesa en la función atencionesAsociadosProceso
		//2.- El o los datos
		//3.- Luego se llama a una función una vez que se enviaron los datos y se obtuvo una respuesta
		$.post("../controllers/estadisticas.php?funcion=atencionesAsociadosProceso", datos).done(function (data) {
			var data = $.parseJSON(data);
			var total_atenciones = 0;

			//Información para manejar el bar_chart_data 
			bar_chart_data = [];

			var tot_asociados = "";

			//Recorremos para calcular el total de atenciones de los asociados en el dia y para rellenar la info del bar_chart_data
			for (x = 0; x < data.length; x++) {
				total_atenciones = total_atenciones + parseInt(data[x].cantidad);
				

				var nombre = data[x].nombre;
				var cantidad = parseInt(data[x].cantidad);
				
				
				//Muestro los datos en la parte inferior
				tot_asociados = tot_asociados + " " + nombre + " solicitó: " + cantidad + " atención/es. Su DNI es: " + data[x].numdoc + "<br>";

				bar_chart_data[x] = {
					nombre: nombre,
					cantidad: cantidad,
				};
			}

			console.log(bar_chart_data);

			$("#tot-atenciones").text(total_atenciones);
			//$("#tot-asociados").text(tot_asociados);
			document.getElementById("tot-asociados").innerHTML=tot_asociados;

			var config = {
				data: bar_chart_data,
				xkey: 'nombre',
				ykeys: ['cantidad'],
				labels: 'cantidad',
				resize: true,
				fillOpacity: 0.6,
				behaveLikeLine: true,
				hideHover: 'auto',
				resize: true,
				pointFillColors: ['#ffffff'],
				pointStrokeColors: ['black'],
				lineColors: ['gray', 'red']
			}

			config.element = 'asociados-estadisticas';
			config.stacked = true;
			Morris.Bar(config);
		});
	}
</script> {% endblock %}